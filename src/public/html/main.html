<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="/css/main.css">
  <script src="/components/topnav.js" type="text/javascript" defer></script>
</head>

<body>
  <topnav-component></topnav-component>
  <div id="template-div">
    <h2>Saved Templates</h2>
    <a href="/editor" id="editor-link" class="editor-link" title="Add new template">
      <img src="/images/plus.png" alt="" width="24px" height="24px">
    </a>
  </div>
  <div id="template-list"></div>
  <div id="template-div">
    <h2>Default Templates</h2>
  </div>
  <div id="default-template-list"></div>
</body>
<script>
  const queryString = window.location.search;
  const urlParams = new URLSearchParams(queryString);

  let email = urlParams.get('email');
  let firstName = urlParams.get('firstName');
  let lastName = urlParams.get('lastName');
  let admin = urlParams.get('admin');

  if (email != null && firstName != null && lastName != null) {
    localStorage.setItem('email', email);
    localStorage.setItem('firstName', firstName);
    localStorage.setItem('lastName', lastName);
    localStorage.setItem('admin', admin);
  } else {
    email = localStorage.getItem('email');
    firstName = localStorage.getItem('firstName');
    lastName = localStorage.getItem('lastName');
    admin = localStorage.getItem('admin');
  }
  
  fetch(`/api/pdf-templates/${email}`, {
    method: "GET",
    headers: {
      "Content-type": "application/json; charset=UTF-8"
    }
  })
    .then(response => response.json())
    .then(json => {
      const pdfList = document.getElementById("template-list");

      for (let item of json) {
        insertPdfInto(pdfList, item, true, false);
      }
    });

  fetch(`/api/default-pdfs`, {
    method: "GET",
    headers: {
      "Content-type": "application/json; charset=UTF-8"
    }
  })
    .then(response => response.json())
    .then(json => {
      const pdfList = document.getElementById("default-template-list");

      for (let item of json) {
        insertPdfInto(pdfList, item, admin, true);
      }
    });

  window.onload = (() => {
    setParams();
  });

  function insertPdfInto(element, pdf, deletable, defaultPdf) {
    const pdfItem = document.createElement("div");
    pdfItem.classList.add("pdf-item");

    const docImage = document.createElement("img");
    docImage.src = "/images/doc.png";
    docImage.classList.add("doc-image");
    pdfItem.appendChild(docImage);

    const info = document.createElement("div");
    info.classList.add("info");

    const filename = document.createElement("div");
    filename.classList.add("filename");
    filename.innerText = pdf.filename;

    info.appendChild(filename);

    const editButton = document.createElement("button");
    editButton.innerText = "Edit";
    editButton.classList.add("edit-button");

    editButton.onclick = (() => {
      if (defaultPdf == false) {
        window.location = `/editor?id=${pdf.id}`;
      } else {
        window.location = `/editor?defaultId=${pdf.id}`;
      }
    });
    const buttons = document.createElement("div");
    buttons.classList.add("buttons-div");
    buttons.appendChild(editButton);

    if (deletable) {
      const deleteButton = document.createElement("button");
      deleteButton.innerText = "Delete";
      deleteButton.classList.add("delete-button");

      deleteButton.onclick = (() => {
        const url = defaultPdf ? `/api/default-pdf/${pdf.id}` : `/api/pdf-templates/${email}/${pdf.id}`;

        fetch(url, {
          method: "DELETE",
          headers: {
            "Content-type": "application/json; charset=UTF-8"
          }
        })
          .then(response => response.json())
          .then(json => {

            if (json.status === 200) {
              element.removeChild(pdfItem);
            }
          });
      });

      buttons.appendChild(deleteButton);
    }
    info.appendChild(buttons);
    pdfItem.appendChild(info);
    element.appendChild(pdfItem)
  }
</script>

</html>